On a vu dans la section précédente que l'on est capable d'exprimer un spectre théorique $\widehat{Y}$ à partir des paramètres hyperfins (et des autres paramètres ajustables) contenus dans $B$.
En notant $Y$ le vecteur contenant l'ensemble des données du spectre expérimental, on cherche à à ajuster $B$, de manière à minimiser la grandeur 
\begin{equation}
\phi = \sum^{n}_{i=1} \left[Y_i - \widehat{Y}_i\right]
\end{equation}
où $n$ est le nombre de données (nombre de canaux), $Y_i$ est la valeur mesurée dans le $i$ème canal du spectre..

Mosfit utilise une version simplifiée de l'algorithme de moindres carrés décrit par Marquardt \cite{marquardt}.
Le schéma de cette algorithme est présenté en figure \ref{fig:marquardt}.
À chaque itération, on calcule $B^r$, une valeur ajustée de $B$. $B^r_j$ est le $j$ième paramètre de $B^r$. 
 La résolution de l'équation (32) de Marquardt\cite{marquardt} permet de determiner $\delta^r$ tel que 
\begin{equation}
  B^r = B^{r-1} + \delta^r 
\end{equation}
L'algorithme fait intervenir une grandeur $\lambda$, ainsi que les dérivées de $\hat{Y}$ par rapport à chaque membre de $B$.
Ces derivées sont calculées numériquement.
Les itérations s'arrêtent lorsque qu'un critère de convergence $\epsilon=10^{-3}$ est atteint, ce qui est le cas si on verifie :
\begin{equation}
 \forall~j,~~~\epsilon > \frac{|B^r_j - B^{r-1}_j|}{|B^r_j|},
\end{equation} 
ou lorsque le nombre d'itération dépasse la limite \lstinline{NMAX} fixée.


\begin{figure}
\includegraphics[width=\linewidth]{marquardt.png}
\caption{\label{fig:marquardt}Algorithme de moindres carrés de Marquardt simplifié. Inspiré de "Application of marquardt's nonlinear least squares
algorithm to free-flight yaw data analysis"}
\end{figure}

